const{ipcRenderer:ipcRenderer,remote:remote}=require("electron"),isDev=require("electron-is-dev");var tabID=0;const{Menu:Menu,MenuItem:MenuItem}=remote,ANIMATION_SPEED=200,path=require("path");var lastid;fs=require("fs");var shown=!0;const online=window.navigator.onLine;search=$("#search"),doc=$(document),content=$("#content");var tabContainer=[],overlayup=!1,currentTabID=0,currentURL="",currentScroll=0,lastScroll=0,init_page=function(){var e=document.querySelector("#webview");$(".indicator");e.addEventListener("page-title-updated",function(){$("#search").val(e.getURL()),csspath=path.resolve(__dirname,"scrollbar.css"),css=fs.readFileSync(csspath,"utf8"),e.insertCSS(css),lastid&&$("option").each(function(e,t){$(t).attr("value")==lastid&&$(t).remove()})}),e.addEventListener("did-fail-load",failload),e.addEventListener("did-get-response-details",function(e){}),e.addEventListener("ipc-message",function(e){"navAttempt"==e.channel&&(clickedURL=e.args[0],clickedURL&&loadURL(clickedURL)),"scrollY"==e.channel&&(currentScroll=e.args[0])})};doc.ready(function(){$(".overlay").fadeOut(0),loadBookmarks(),arg=remote.getGlobal("sharedObj").args[isDev?2:1],init_page(),lastHeight=$(window).height(),$(window).resize(function(){$(this).height()!=lastHeight&&($("#top").css("top","0px"),$("#bookmarks").css("top","0px"),lastHeight=$(window).height())}),doc.bind("mousewheel",function(e){$(window).height(),$(window).height();e.originalEvent.wheelDelta/120>0&&"-25px"==$("#top").css("top")?($("#top").animate({top:0},200),$("#bookmarks").animate({top:25},200),resizeContent(200)):e.originalEvent.wheelDelta/120<=0&&"0px"==$("#top").css("top")&&($("#top").animate({top:-25},200),$("#bookmarks").animate({top:0},200),resizeContent(200))}),window.setTimeout(checkArgs,100)});var checkArgs=function(){if(arg){if(!fs.existsSync(arg))return void(arg.startsWith("http")?loadURL(arg):loadURL("file:\\\\"+__dirname+"\\pages\\DNE.html"));if(ext=path.extname(arg),".url"==ext)fs.readFile(arg,"utf8",function(e,t){let o=t.split("URL=")[1];loadURL(o)});else if(".html"==ext){let e=path.resolve(arg);loadURL(e)}}},loadURL=function(e,t=0){lastScroll=currentScroll,$("#search").focusout(),webview.loadURL(e,{extraHeaders:"DNT:1\n"}),webview.send("scrollTo",scroll)},failload=function(e){-105==e.errorCode&&webview.loadURL("http://google.com/search?q="+encodeURI(val)),online||webview.loadURL("file://pages/offline.html")};const resizeContent=function(e=200){const t="-25px"==$("#top").css("top"),o=$(window).outerHeight()-50,i=$(window).outerHeight()-25;switch(t){case!0:content.animate({top:"50px",height:o},e);break;case!1:content.animate({top:"25px",height:i},e)}},tld=require("tldjs"),match=function(e){return splitquery=e.split("."),e.startsWith("r/")||e.startsWith("/r/")?"https://reddit.com/r/"+e.split("r/")[1]:e.startsWith("file://")?e:e.startsWith(":://")?"Run Command: "+e.split(":://")[1]:e.startsWith("http://")||e.startsWith("https://")?e:e.startsWith("www.")?"http://"+e:1==splitquery.length?"http://google.com/search?q="+encodeURI(e):(domain=splitquery[splitquery.length-2]+"."+splitquery[splitquery.length-1],tld.isValid(domain)?"http://"+e:e)},getDomain=function(e){return e.split("://")[1].split("/")[0]};doc.on("mousemove",function(e){e.pageY>$(window).height()-40&&0==shown?($("#mynavbar").slideDown(200),shown=!0):e.pageY<=$(window).height()-40&&1==shown&&!$("#search").hasClass("searchfocus")&&($("#mynavbar").slideUp(200),shown=!1)}),$("#close").on("click",function(){remote.getCurrentWindow().close()}),$("#min").on("click",function(){remote.getCurrentWindow().minimize()}),$("#max").on("click",function(){const e=remote.getCurrentWindow();e.isMaximized()?e.unmaximize():e.maximize(),setTimeout(resizeContent,100)}),$("#back").on("click",function(){webview.goBack()}),$("#forward").on("click",function(){webview.goForward()}),$("#bkmks").on("click",function(){$("#bookmarkPopup").css("display","flex").hide().fadeIn(200),$(".bookmark").each((e,t)=>{$(t).append('<i style="position:relative" class="fa fa-times bookmarkX" aria-hidden="true"></i>')})}),$("#closePopup").on("click",function(){$("#bookmarkPopup").fadeOut(200),$(".bookmarkX").remove()}),$("#addBookmark").on("click",function(){saveBookmark($("#bookmarkName").val(),$("#bookmarkUrl").val())}),$("#export").on("click",exportBookmarks),$("#import").on("click",importBookmarks),$("#dev").on("click",()=>webview.openDevTools()),doc.keydown(function(e){123===e.keyCode&&remote.getCurrentWindow().toggleDevTools(),116===e.keyCode&&webview.reload(),27==e.keyCode&&webview.sendInputEvent({type:"keyDown",keyCode:"Esc"})}),doc.keyup(function(e){"complete"===document.readyState&&(18!=e.keyCode||overlayup?18==e.keyCode&&overlayup&&($(".overlay").fadeOut(200),overlayup=!1):(initializeTabs(),$(".overlay").fadeIn(200),overlayup=!0))}),$("#search").keyup(function(e){if(updateSearchText(),"Enter"==e.key){let e=getSearchQuery();if(e.startsWith(":://")){let t=e.split(":://")[1];return console.log(t),void(Object.keys(commands).includes(t)?commands[t]():alert(`${t} is not a valid command`))}e&&($("#search").val("Loading!"),loadURL(match(e)))}});const updateSearchText=function(){$("#searchMatch").text(match(getSearchQuery()))};$("#search").focus(function(){$(this).addClass("searchfocus")}),$("#search").focusout(function(){$(this).removeClass("searchfocus")});const getSearchQuery=function(){return $("#search").val()};var loadTab=function(e){for(let t=0;t<tabContainer.length;t++)if(tabContainer[t].id===e.id){currentTabID=t;break}$(".awebview").each(function(t,o){if($(o).css("visibility","hidden"),$(o).attr("id","hiddentab"),$(o).attr("tabID")==e.id)return $(o).css("visibility","visible"),void $(o).attr("id","webview")}),init_page(),$(".overlay").fadeOut(200),overlayup=!1};class tab{constructor(e,t,o,i,a){this.URL=e,this.width=t,this.height=o,this.imgsrc=i,this.id=a,this.currwebview='<webview id="webview" preload="src/preload.js" tabID="'+this.id+'" style="visibility:visible" class="awebview" src="'+e+'"></webview>'}getThumbnail(){return'<div class="tabContainer">        <i class="fa fa-times closeTab" id="closeTab'+this.id+'" aria-hidden="true"></i>        <img class="tabPreview" src="'+this.imgsrc+'"id="tab'+this.id+'" style ="width:'+this.width+";height:"+this.height+'">        </img></div>'}remove(e){if($(".webview").each(function(e,t){$(t).attr("tabID")==this.id.toString()&&$(t).remove()}),1==e.length&&e[0].id==this.id){for(let t=0;t<e.length;t++)if(e[t].id==this.id)return void e.splice(t,1);tabID+=1;let t=new tab("file://pages/homepage.html",this.width,this.height,"null",tabID);e.push(t),$("#content").prepend(t.currwebview),loadTab(t)}for(let t=0;t<e.length;t++)if(e[t].id==this.id){e.splice(t,1);let o=e[t-1]?t-1:t;return void loadTab(e[o])}}}const initializeTabs=function(){$(".tabs").empty(),img=webview.capturePage(function(e){let t=e.toDataURL(),o=(200*e.getAspectRatio()).toString()+"px";0==tabContainer.length&&(tabContainer[0]=new tab(webview.getURL(),o,"200px",t,tabID)),tabContainer[currentTabID].imgsrc=t,tabContainer[currentTabID].width=o;for(let e=0;e<tabContainer.length;e++)$(".tabs").append(tabContainer[e].getThumbnail());$(".tabs").append('<div class="tabContainer"><div class="tabPreview" id="newTab"             style ="width:'+o+';height:200px;background-color:rgba(0,0,0,0.5)">            <i class="fa fa-plus-square-o fa-4x" style="position:relative;top: 50%;transform: translateY(-50%);" aria-hidden="true"></i>            </div></div>'),$(".tabPreview").on("click",function(){if("newTab"==$(this).attr("id"))tabID+=1,newtab=new tab("pages/homepage.html",$(this).width(),$(this).height(),$(this).attr("src"),tabID),tabContainer.push(newtab),$("#content").prepend(newtab.currwebview),loadTab(newtab);else for(let e=0;e<tabContainer.length;e++)peekTab=tabContainer[e],"tab"+peekTab.id==$(this).attr("id")&&loadTab(peekTab)}),$(".closeTab").on("click",function(){let e=$(this).attr("id").split("closeTab")[1];$("#tab"+e).fadeOut(200,function(){for(let t=0;t<tabContainer.length;t++){let o=tabContainer[t];o.id==e&&o.remove(tabContainer)}$(this).remove()})})})},commands={store:()=>{localStorage.setItem("lastname","Smith")}},dialog=require("electron").remote.dialog;function saveBookmark(e,t){let o=JSON.parse(localStorage.getItem("bookmarks"))||{};o[e]?editBookmarkLink(e,t):addBookmarkLink(e,t),o[e]=t,localStorage.setItem("bookmarks",JSON.stringify(o))}function removeBookmark(e){let t=JSON.parse(localStorage.getItem("bookmarks"))||{};delete t[e],removeBookmarkLink(e),localStorage.setItem("bookmarks",JSON.stringify(t))}function exportBookmarks(){let e=localStorage.getItem("bookmarks"),t=dialog.showSaveDialog({filters:[{name:"json",extensions:["json"]}]});fs.writeFile(t,e,"utf8",()=>alert(`Exported bookmarks to ${t}`))}function importBookmarks(){if(!confirm("WARNING: This will override existing bookmarks. Continue?"))return;let e=dialog.showOpenDialog({filters:[{name:"json",extensions:["json"]}]});fs.readFile(e[0],(e,t)=>{if(e)throw e;localStorage.setItem("bookmarks",t),loadBookmarks()})}function addBookmarkLink(e,t){$("#bookmarks").append(`<a class="bookmark" id=${e} url=${t}>${e}</a>`),$(`#${e}`).click(function(){if("flex"==$("#bookmarkPopup").css("display"))return removeBookmark(e);const t=$(this).attr("url"),o=match(t);loadURL(o)})}function editBookmarkLink(e,t){$(`#${e}`).attr("url",t)}function removeBookmarkLink(e){$(`#${e}`).remove()}function loadBookmarks(){let e=JSON.parse(localStorage.getItem("bookmarks"))||{};for(let[t,o]of Object.entries(e))addBookmarkLink(t,o)}